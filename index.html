<script>
  function hideLoaderNow() {
    const cover = document.getElementById("loaderCover");
    if (!cover) return;
    // if already hidden, skip
    if (cover.style.display === "none") return;
    cover.classList.add("coverFade");
    // remove from flow after fade
    setTimeout(()=>{ cover.style.display = "none"; }, 280);
  }

  function startUnity(){
    fitGame();
    try{
      if (window.UnityLoader && typeof UnityLoader.instantiate === "function"){
        // Watchdog: when a canvas appears and starts drawing, hide loader
        const container = document.getElementById("gameContainer");
        let drewOnce = false;
        function canvasWatchdog(){
          const c = container && container.querySelector("canvas");
          if (c && c.width > 0 && c.height > 0) {
            try {
              const gl = c.getContext("webgl2") || c.getContext("webgl") || c.getContext("experimental-webgl");
              // if we got a context and a frame likely drew, hide
              if (gl && gl.drawingBufferWidth > 0 && gl.drawingBufferHeight > 0) {
                drewOnce = true;
                hideLoaderNow();
                return;
              }
            } catch(_) {}
          }
          if (!drewOnce) requestAnimationFrame(canvasWatchdog);
        }
        requestAnimationFrame(canvasWatchdog);

        // Unity instantiate with progress + Module hooks
        window.gameInstance = UnityLoader.instantiate("gameContainer", "slope_new.json", {
          onProgress: function(game, p){
            // keep your existing progress integration
            if (typeof window.UnityProgress === "function") window.UnityProgress(game, p);
            // if Unity reports 100 percent, give it a short settle then hide
            if (p >= 1) setTimeout(hideLoaderNow, 150);
          },
          Module: {
            onRuntimeInitialized: function(){
              // engine core is ready
              setTimeout(hideLoaderNow, 120);
            },
            postRun: function(){
              // player finished loading scene
              hideLoaderNow();
            }
          }
        });

        // Fallback: if everything else fails but 7 seconds have passed after 100 percent, hide
        let afterHundredTimer = null;
        const origUP = window.UnityProgress;
        window.UnityProgress = function(game, p){
          try { if (origUP) origUP(game, p); } catch(_){}
          if (p >= 1 && !afterHundredTimer) {
            afterHundredTimer = setTimeout(hideLoaderNow, 7000);
          }
        };

      } else {
        console.error("UnityLoader.js missing or invalid");
        hideLoaderNow();
      }
    } catch (e){
      console.error("Unity failed to start:", e);
      hideLoaderNow();
    }
  }
  window.addEventListener("load", startUnity);
</script>
